{% extends "base.html" %}

{% block title %}Test - {{ child.name }} (Ages 12-14){% endblock %}

{% block extra_css %}
<style>
    /* Age 12-14: Sophisticated, Professional Design */
    .age-12-14 {
        background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: #e2e8f0;
    }
    
    .test-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px;
        position: relative;
    }
    
    /* Cyber Grid Background */
    .cyber-grid {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            linear-gradient(rgba(102, 126, 234, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(102, 126, 234, 0.1) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: -1;
        opacity: 0.3;
        animation: gridMove 20s linear infinite;
    }
    
    /* Main Test Interface */
    .test-interface {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid rgba(102, 126, 234, 0.2);
        padding: 40px;
        margin: 40px 0;
        box-shadow: 
            0 30px 60px rgba(0, 0, 0, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        animation: interfaceAppear 1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Sophisticated Header */
    .test-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        padding-bottom: 25px;
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
    }
    
    .test-info {
        display: flex;
        align-items: center;
        gap: 25px;
    }
    
    .test-title {
        font-size: 2.2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
    }
    
    .test-title::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 0;
        width: 100px;
        height: 4px;
        background: linear-gradient(90deg, #667eea, transparent);
        border-radius: 2px;
    }
    
    /* Advanced Timer */
    .timer-advanced {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 18px;
        padding: 20px 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        animation: timerGlow 3s infinite alternate;
    }
    
    .timer-display {
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 2.5rem;
        font-weight: 700;
        color: #60a5fa;
        text-shadow: 0 0 20px rgba(96, 165, 250, 0.5);
    }
    
    .timer-label {
        font-size: 0.9rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    /* Progress Ring */
    .progress-ring {
        width: 60px;
        height: 60px;
    }
    
    .progress-ring-circle {
        fill: none;
        stroke: #667eea;
        stroke-width: 4;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dashoffset 0.5s ease;
    }
    
    /* Question Display */
    .question-display {
        margin: 40px 0;
        animation: questionReveal 0.8s ease-out;
    }
    
    .question-metadata {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 20px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 15px;
        border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .question-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #c7d2fe;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .question-number::before {
        content: '#';
        color: #667eea;
        font-size: 1.2rem;
    }
    
    .difficulty-badge {
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .difficulty-easy {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), transparent);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #4ade80;
    }
    
    .difficulty-medium {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), transparent);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: #fbbf24;
    }
    
    .difficulty-hard {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), transparent);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #f87171;
    }
    
    .question-content {
        background: rgba(30, 41, 59, 0.7);
        border-radius: 20px;
        padding: 35px;
        margin: 25px 0;
        border: 1px solid rgba(102, 126, 234, 0.2);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    
    .question-text {
        font-size: 1.4rem;
        line-height: 1.8;
        color: #e2e8f0;
        margin-bottom: 0;
    }
    
    /* Matrix-Style Options Grid */
    .options-matrix {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin: 40px 0;
    }
    
    .option-matrix-item {
        background: rgba(30, 41, 59, 0.8);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 18px;
        padding: 30px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        animation: optionMatrixAppear 0.6s ease-out forwards;
        opacity: 0;
        transform: translateY(30px);
    }
    
    .option-matrix-item:nth-child(1) { animation-delay: 0.1s; }
    .option-matrix-item:nth-child(2) { animation-delay: 0.2s; }
    .option-matrix-item:nth-child(3) { animation-delay: 0.3s; }
    .option-matrix-item:nth-child(4) { animation-delay: 0.4s; }
    
    .option-matrix-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(102, 126, 234, 0.1), 
            transparent);
        transition: left 0.8s;
    }
    
    .option-matrix-item:hover::before {
        left: 100%;
    }
    
    .option-matrix-item:hover {
        border-color: #667eea;
        transform: translateY(-5px) scale(1.02);
        box-shadow: 
            0 20px 40px rgba(102, 126, 234, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .option-matrix-item.selected {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
        border-color: #667eea;
        box-shadow: 
            0 25px 50px rgba(102, 126, 234, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        animation: selectedMatrixPulse 2s infinite;
    }
    
    .option-label-matrix {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .option-letter-matrix {
        width: 45px;
        height: 45px;
        line-height: 45px;
        text-align: center;
        background: rgba(102, 126, 234, 0.2);
        border: 2px solid rgba(102, 126, 234, 0.5);
        border-radius: 12px;
        font-weight: 700;
        font-size: 1.1rem;
        color: #c7d2fe;
        transition: all 0.4s ease;
    }
    
    .option-matrix-item.selected .option-letter-matrix {
        background: #667eea;
        border-color: #667eea;
        color: white;
        transform: rotate(360deg);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }
    
    .option-text-matrix {
        font-size: 1.2rem;
        line-height: 1.6;
        color: #cbd5e1;
        flex: 1;
    }
    
    /* Navigation Controls */
    .navigation-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 50px;
        padding-top: 30px;
        border-top: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .nav-control {
        padding: 18px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 15px;
        border: none;
        background: rgba(30, 41, 59, 0.8);
        color: #cbd5e1;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(102, 126, 234, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .nav-control::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(102, 126, 234, 0.2), 
            transparent);
        transition: left 0.6s;
    }
    
    .nav-control:hover::before {
        left: 100%;
    }
    
    .nav-control:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: #667eea;
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(102, 126, 234, 0.2);
    }
    
    .nav-control:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        transform: none !important;
    }
    
    .nav-control-next {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
        border: 1px solid rgba(102, 126, 234, 0.5);
    }
    
    .nav-control-submit {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(21, 128, 61, 0.3));
        border: 1px solid rgba(34, 197, 94, 0.5);
    }
    
    /* Stats Dashboard */
    .stats-dashboard {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 20px;
        padding: 30px;
        margin: 40px 0;
        border: 1px solid rgba(102, 126, 234, 0.2);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 25px;
    }
    
    .stat-card {
        background: rgba(30, 41, 59, 0.7);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        border: 1px solid rgba(102, 126, 234, 0.1);
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    .stat-value {
        font-size: 2.2rem;
        font-weight: 800;
        color: #667eea;
        margin-bottom: 10px;
        font-family: 'JetBrains Mono', monospace;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    /* Animations */
    @keyframes gridMove {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
    }
    
    @keyframes interfaceAppear {
        from {
            opacity: 0;
            transform: translateY(50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    @keyframes timerGlow {
        0% { box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3); }
        100% { box-shadow: 0 15px 45px rgba(102, 126, 234, 0.5); }
    }
    
    @keyframes questionReveal {
        from {
            opacity: 0;
            transform: translateX(-50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes optionMatrixAppear {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes selectedMatrixPulse {
        0%, 100% { 
            box-shadow: 
                0 25px 50px rgba(102, 126, 234, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        50% { 
            box-shadow: 
                0 30px 60px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
    }
    
    /* Loading Animation */
    .cyber-loading {
        text-align: center;
        padding: 60px;
    }
    
    .loading-binary {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.2rem;
        color: #667eea;
        letter-spacing: 3px;
        animation: binaryBlink 1.5s infinite;
    }
    
    @keyframes binaryBlink {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
        .test-container {
            padding: 20px;
        }
        
        .test-interface {
            padding: 30px;
        }
    }
    
    @media (max-width: 992px) {
        .options-matrix {
            grid-template-columns: 1fr;
        }
        
        .stats-dashboard {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .test-header {
            flex-direction: column;
            gap: 25px;
            align-items: flex-start;
        }
    }
    
    @media (max-width: 768px) {
        .test-interface {
            padding: 20px;
            margin: 20px 0;
        }
        
        .question-content {
            padding: 25px;
        }
        
        .option-matrix-item {
            padding: 20px;
        }
        
        .navigation-controls {
            flex-direction: column;
            gap: 20px;
        }
        
        .nav-control {
            width: 100%;
            justify-content: center;
        }
        
        .timer-advanced {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }
    }
    
    @media (max-width: 576px) {
        .stats-dashboard {
            grid-template-columns: 1fr;
        }
        
        .question-text {
            font-size: 1.2rem;
        }
        
        .test-title {
            font-size: 1.8rem;
        }
        
        .timer-display {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="test-container" class="age-12-14">
    <!-- Cyber Grid Background -->
    <div class="cyber-grid"></div>
    
    <div class="test-container">
        <!-- Debug Info (remove in production) -->
        <div class="alert alert-info mb-4" style="background: rgba(102, 126, 234, 0.1); border-color: #667eea; color: #c7d2fe;">
            <h5><i class="fas fa-bug me-2"></i> Debug Info</h5>
            <p>Questions loaded: {{ questions|length }} | Age Group: {{ age_group }}</p>
            {% if questions %}
                <p class="mb-0">First question: {{ questions[0].question[:50] }}...</p>
            {% else %}
                <p class="mb-0 text-warning">No questions loaded!</p>
            {% endif %}
        </div>
        
        <!-- Stats Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-card">
                <div class="stat-value" id="current-question">1</div>
                <div class="stat-label">Current</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-questions">{{ questions|length }}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="progress-percentage">0%</div>
                <div class="stat-label">Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="answered-count">0</div>
                <div class="stat-label">Answered</div>
            </div>
        </div>
        
        <!-- Main Test Interface -->
        <div class="test-interface">
            <!-- Header with Timer -->
            <div class="test-header">
                <div class="test-info">
                    <h1 class="test-title">
                        <i class="fas fa-brain me-2"></i>
                        Advanced Cognitive Test
                        <span class="fs-5 d-block text-muted mt-1">{{ child.name }}, Age {{ child.age }}</span>
                    </h1>
                </div>
                
                <div class="timer-advanced">
                    <div class="progress-ring">
                        <svg width="60" height="60">
                            <circle class="progress-ring-circle" cx="30" cy="30" r="28"></circle>
                        </svg>
                    </div>
                    <div>
                        <div class="timer-display" id="timer">30:00</div>
                        <div class="timer-label">Time Remaining</div>
                    </div>
                </div>
            </div>
            
            <!-- Question Display Area -->
            <div id="test-content">
                {% if questions %}
                <div class="cyber-loading">
                    <div class="loading-binary">01101000 01100101 01101100 01101100 01101111</div>
                    <h4 class="mt-4">Initializing Advanced Assessment...</h4>
                    <p class="text-muted">Loading {{ questions|length }} cognitive challenges</p>
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <h4><i class="fas fa-exclamation-triangle"></i> No Questions Available</h4>
                    <p>Could not load questions for this test. Please try again or contact support.</p>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Back to Dashboard</a>
                </div>
                {% endif %}
            </div>
            
            <!-- Navigation Controls -->
            <div class="navigation-controls">
                <button id="prev-btn" class="nav-control" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button id="next-btn" class="nav-control nav-control-next">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div id="completion-modal" class="modal fade" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background: #0f172a; border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 20px;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(102, 126, 234, 0.3);">
                <h5 class="modal-title" style="color: #c7d2fe;">
                    <i class="fas fa-chart-network me-2"></i>
                    Assessment Results
                </h5>
                <div style="color: #94a3b8;">
                    <i class="fas fa-calendar-alt me-1"></i>
                    {{ now().strftime('%Y-%m-%d') if now else 'Today' }}
                </div>
            </div>
            <div class="modal-body p-5">
                <div id="result-content">
                    <!-- Results will be displayed here -->
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(102, 126, 234, 0.3);">
                <div class="d-flex justify-content-between w-100">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-home me-2"></i> Dashboard
                    </a>
                    <div>
                        <button id="detailed-analysis" class="btn btn-primary me-2">
                            <i class="fas fa-chart-bar me-2"></i> Detailed Analysis
                        </button>
                        <button id="retry-assessment" class="btn btn-success">
                            <i class="fas fa-sync-alt me-2"></i> Retry Assessment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pass data from Flask to JavaScript
    const questions = {{ questions|tojson }};
    const childId = {{ child.id }};
    const ageGroup = "{{ age_group }}";
    const childName = "{{ child.name }}";
    const totalQuestions = questions ? questions.length : 0;
    
    // Debug logging
    console.log("=== TEST DEBUG INFO ===");
    console.log("Child:", childName);
    console.log("Age Group:", ageGroup);
    console.log("Total Questions:", totalQuestions);
    console.log("Questions data:", questions);
    console.log("Child ID:", childId);
    console.log("=== END DEBUG ===");
    
    // Check if questions are available
    if (!questions || questions.length === 0) {
        console.error("ERROR: No questions available!");
        document.getElementById('test-content').innerHTML = `
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-triangle"></i> Test Error</h4>
                <p>No questions available for this test. Please try again.</p>
                <button onclick="window.location.reload()" class="btn btn-primary">Reload</button>
            </div>
        `;
        document.getElementById('prev-btn').disabled = true;
        document.getElementById('next-btn').disabled = true;
        throw new Error("No questions available");
    }
    
    // Update progress ring
    function updateProgressRing(percent) {
        const circle = document.querySelector('.progress-ring-circle');
        if (!circle) return;
        
        const radius = 28;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percent / 100) * circumference;
        
        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = offset;
    }
    
    // Binary loading effect
    function createBinaryEffect() {
        const binaryElement = document.querySelector('.loading-binary');
        if (!binaryElement) return;
        
        const originalText = binaryElement.textContent;
        let iteration = 0;
        
        const interval = setInterval(() => {
            binaryElement.textContent = originalText
                .split('')
                .map((char, index) => {
                    if (char === ' ') return ' ';
                    return Math.random() > 0.5 ? '1' : '0';
                })
                .join('');
            
            iteration++;
            if (iteration > 10) {
                clearInterval(interval);
                binaryElement.textContent = originalText;
            }
        }, 100);
    }
    
    // Simple test functionality
    let currentQuestion = 0;
    let answers = [];
    let timeLeft = 30 * 60;
    let timerInterval;
    
    function displayQuestion(index) {
        if (index < 0 || index >= questions.length) return;
        
        const question = questions[index];
        const optionsHtml = question.options.map((option, i) => `
            <div class="option-matrix-item" onclick="selectOption(${i})" data-index="${i}">
                <div class="option-label-matrix">
                    <span class="option-letter-matrix">${String.fromCharCode(65 + i)}</span>
                    <div class="option-content-advanced">
                        <div class="option-text-matrix">${option}</div>
                    </div>
                </div>
            </div>
        `).join('');
        
        const difficultyClass = question.difficulty === 1 ? 'difficulty-easy' : 
                              question.difficulty === 2 ? 'difficulty-medium' : 'difficulty-hard';
        const difficultyLabel = question.difficulty === 1 ? 'Easy' : 
                               question.difficulty === 2 ? 'Medium' : 'Hard';
        
        document.getElementById('test-content').innerHTML = `
            <div class="question-display">
                <div class="question-metadata">
                    <div class="question-number">
                        Question ${index + 1}
                    </div>
                    <div class="difficulty-badge ${difficultyClass}">
                        ${difficultyLabel}
                    </div>
                </div>
                
                <div class="question-content">
                    <div class="question-text">
                        ${question.question.replace(/<br>/g, '<br>')}
                    </div>
                </div>
                
                <div class="options-matrix">
                    ${optionsHtml}
                </div>
            </div>
        `;
        
        // Update current question display
        document.getElementById('current-question').textContent = index + 1;
        
        // Update progress
        const progressPercent = ((index + 1) / questions.length) * 100;
        document.getElementById('progress-percentage').textContent = Math.round(progressPercent) + '%';
        updateProgressRing(progressPercent);
        
        // Update navigation buttons
        document.getElementById('prev-btn').disabled = index === 0;
        document.getElementById('next-btn').textContent = index === questions.length - 1 ? 'Submit' : 'Next';
        document.getElementById('next-btn').className = index === questions.length - 1 ? 
            'nav-control nav-control-submit' : 'nav-control nav-control-next';
        
        // Restore previous answer if exists
        const existingAnswer = answers.find(a => a.question_id === question.id);
        if (existingAnswer) {
            selectOption(existingAnswer.option_index);
        }
    }
    
    window.selectOption = function(optionIndex) {
        // Remove selection from all options
        document.querySelectorAll('.option-matrix-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Add selection to clicked option
        const selectedOption = document.querySelector(`.option-matrix-item[data-index="${optionIndex}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
            
            // Save answer
            const question = questions[currentQuestion];
            const existingIndex = answers.findIndex(a => a.question_id === question.id);
            
            const answerData = {
                question_id: question.id,
                answer: question.options[optionIndex],
                option_index: optionIndex,
                category: question.category,
                type: question.type,
                difficulty: question.difficulty
            };
            
            if (existingIndex > -1) {
                answers[existingIndex] = answerData;
            } else {
                answers.push(answerData);
            }
            
            // Update answered count
            document.getElementById('answered-count').textContent = answers.length;
        }
    }
    
    function startTimer() {
        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitTest();
            }
            timeLeft--;
        }
        
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    function nextQuestion() {
        if (currentQuestion < questions.length - 1) {
            currentQuestion++;
            displayQuestion(currentQuestion);
        } else {
            submitTest();
        }
    }
    
    function prevQuestion() {
        if (currentQuestion > 0) {
            currentQuestion--;
            displayQuestion(currentQuestion);
        }
    }
    
    async function submitTest() {
        clearInterval(timerInterval);
        
        // Show loading
        document.getElementById('test-content').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-4">Processing Results...</h4>
                <p class="text-muted">Analyzing your cognitive performance</p>
            </div>
        `;
        
        try {
            const response = await fetch(`/submit_test/${childId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    answers: answers,
                    time_taken: (30 * 60) - timeLeft
                })
            });
            
            const result = await response.json();
            showResults(result);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('test-content').innerHTML = `
                <div class="alert alert-danger">
                    <h4>Submission Error</h4>
                    <p>${error.message}</p>
                    <button onclick="window.location.reload()" class="btn btn-primary">Retry</button>
                </div>
            `;
        }
    }
    
    function showResults(result) {
        const resultContent = document.getElementById('result-content');
        const scoreColor = result.score >= 80 ? 'text-success' : 
                          result.score >= 60 ? 'text-warning' : 'text-danger';
        
        resultContent.innerHTML = `
            <div class="text-center">
                <div class="display-1 ${scoreColor} fw-bold mb-3">${result.score.toFixed(1)}%</div>
                <h4 class="mb-4">${result.score >= 80 ? 'Excellent!' : result.score >= 60 ? 'Good Job!' : 'Keep Practicing!'}</h4>
                
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <h5 class="card-title">Correct Answers</h5>
                                <div class="display-4">${result.correct_answers}/${result.total_questions}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <h5 class="card-title">Performance</h5>
                                <div class="display-4">${result.score.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${result.strong_points && result.strong_points.length > 0 ? `
                <div class="alert alert-success mt-3">
                    <h5><i class="fas fa-thumbs-up me-2"></i> Strong Points</h5>
                    <div class="mt-2">
                        ${result.strong_points.map(point => `<span class="badge bg-success me-2 mb-2">${point}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${result.weak_points && result.weak_points.length > 0 ? `
                <div class="alert alert-warning mt-3">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i> Areas for Improvement</h5>
                    <div class="mt-2">
                        ${result.weak_points.map(point => `<span class="badge bg-warning me-2 mb-2">${point}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('completion-modal'));
        modal.show();
        
        // Setup retry button
        document.getElementById('retry-assessment').addEventListener('click', () => {
            modal.hide();
            setTimeout(() => {
                window.location.reload();
            }, 300);
        });
        
        // Setup detailed analysis button
        document.getElementById('detailed-analysis').addEventListener('click', () => {
            alert('Detailed analysis would show comprehensive performance metrics and comparisons.');
        });
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing test...");
        
        if (questions && questions.length > 0) {
            createBinaryEffect();
            updateProgressRing(0);
            
            // Start test after short delay
            setTimeout(() => {
                displayQuestion(0);
                startTimer();
            }, 1000);
            
            // Add event listeners
            document.getElementById('prev-btn').addEventListener('click', prevQuestion);
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
        }
    });
</script>
{% endblock %}